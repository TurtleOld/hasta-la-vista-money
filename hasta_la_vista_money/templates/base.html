{# Load the tag library #}
{% load csp %}
{% load static %}
{% load i18n %}
{% load word_hash %}
{% load compress %}


<!DOCTYPE html>
<html lang="ru" {% if user.is_authenticated and user.theme == 'dark' %}class="dark" data-bs-theme="dark"{% else %}data-bs-theme="light"{% endif %}>
<head>
    {% block head %}
        <title>{% block title %}{% endblock %} - Hasta La Vista, Money!</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link nonce="{{request.csp_nonce}}" rel="shortcut icon" href="{% static 'img/favicon/favicon.ico' %}?v={% word_hash %}" type="image/x-icon">
        <link nonce="{{request.csp_nonce}}" rel="preconnect" href="https://fonts.googleapis.com">
        <link nonce="{{request.csp_nonce}}" rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link nonce="{{request.csp_nonce}}" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&family=Gloria+Hallelujah&display=swap" rel="stylesheet">
<link nonce="{{request.csp_nonce}}" rel="stylesheet" type="text/css" href="{% static 'css/styles.min.css' %}?v={% word_hash %}">
<link nonce="{{request.csp_nonce}}" rel="stylesheet" href="{% static 'css/driver.css' %}">
    {% endblock %}
</head>
<body class="min-h-screen bg-white dark:bg-gray-800 {% if user.is_authenticated %}pb-20 md:pb-0{% endif %}" {% if user.is_authenticated %}data-bs-theme="{{ user.theme|default:'light' }}"{% else %}data-bs-theme="light"{% endif %}>
    {% if user.is_authenticated %}
        <input type="checkbox" id="mobileMenuState" class="peer hidden" autocomplete="off">
        <div class="header">
            {% include 'header.html' %}
        </div>
        {% if messages %}
            <div class="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-full max-w-md px-4 pointer-events-none" role="status" aria-live="polite">
                <div class="flex flex-col gap-3">
                    {% for message in messages %}
                        <div class="pointer-events-auto theme-fade [animation:fadeInUp_0.3s_ease-out,fadeOutSlideUp_0.35s_ease-in_4.2s_forwards]">
                            <div class="relative overflow-hidden rounded-2xl border shadow-xl backdrop-blur supports-[backdrop-filter]:bg-gray-950/75 dark:supports-[backdrop-filter]:bg-white/70 {% if 'error' in message.tags or 'danger' in message.tags %}border-red-400/30 bg-gradient-to-r from-gray-950/90 to-red-950/35 before:absolute before:inset-y-0 before:left-0 before:w-1 before:bg-gradient-to-b before:from-red-400 before:to-rose-400 dark:border-red-200/70 dark:from-red-50/90 dark:to-white/70{% elif 'success' in message.tags %}border-emerald-400/30 bg-gradient-to-r from-gray-950/90 to-emerald-950/35 before:absolute before:inset-y-0 before:left-0 before:w-1 before:bg-gradient-to-b before:from-emerald-400 before:to-green-400 dark:border-emerald-200/70 dark:from-emerald-50/90 dark:to-white/70{% elif 'warning' in message.tags %}border-orange-400/30 bg-gradient-to-r from-gray-950/90 to-orange-950/35 before:absolute before:inset-y-0 before:left-0 before:w-1 before:bg-gradient-to-b before:from-orange-400 before:to-amber-400 dark:border-orange-200/70 dark:from-orange-50/90 dark:to-white/70{% else %}border-blue-400/30 bg-gradient-to-r from-gray-950/90 to-blue-950/35 before:absolute before:inset-y-0 before:left-0 before:w-1 before:bg-gradient-to-b before:from-blue-400 before:to-indigo-400 dark:border-blue-200/70 dark:from-blue-50/90 dark:to-white/70{% endif %}">
                                <div class="flex items-center gap-3 p-4 pl-5">
                                    <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-xl ring-1 ring-inset {% if 'error' in message.tags or 'danger' in message.tags %}bg-red-100/80 text-red-700 ring-red-200 dark:bg-red-900/40 dark:text-red-300 dark:ring-red-900/50{% elif 'success' in message.tags %}bg-emerald-100/80 text-emerald-700 ring-emerald-200 dark:bg-emerald-900/40 dark:text-emerald-300 dark:ring-emerald-900/50{% elif 'warning' in message.tags %}bg-orange-100/80 text-orange-700 ring-orange-200 dark:bg-orange-900/40 dark:text-orange-300 dark:ring-orange-900/50{% else %}bg-blue-100/80 text-blue-700 ring-blue-200 dark:bg-blue-900/40 dark:text-blue-300 dark:ring-blue-900/50{% endif %}">
                                        {% if 'error' in message.tags or 'danger' in message.tags %}
                                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                        {% elif 'success' in message.tags %}
                                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        {% elif 'warning' in message.tags %}
                                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                        {% else %}
                                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm -mb-px font-semibold leading-snug text-center text-white dark:text-gray-900 break-words">
                                            {{ message }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% else %}
        {% if messages %}
            <div class="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-full max-w-md px-4 pointer-events-none" role="status" aria-live="polite">
                <div class="flex flex-col gap-3">
                    {% for message in messages %}
                        <div class="pointer-events-auto theme-fade [animation:fadeInUp_0.3s_ease-out,fadeOutSlideUp_0.35s_ease-in_4.2s_forwards]">
                            <div class="relative overflow-hidden rounded-2xl border shadow-xl backdrop-blur supports-[backdrop-filter]:bg-gray-950/75 dark:supports-[backdrop-filter]:bg-white/70 {% if 'error' in message.tags or 'danger' in message.tags %}border-red-400/30 bg-gradient-to-r from-gray-950/90 to-red-950/35 before:absolute before:inset-y-0 before:left-0 before:w-1 before:bg-gradient-to-b before:from-red-400 before:to-rose-400 dark:border-red-200/70 dark:from-red-50/90 dark:to-white/70{% elif 'success' in message.tags %}border-emerald-400/30 bg-gradient-to-r from-gray-950/90 to-emerald-950/35 before:absolute before:inset-y-0 before:left-0 before:w-1 before:bg-gradient-to-b before:from-emerald-400 before:to-green-400 dark:border-emerald-200/70 dark:from-emerald-50/90 dark:to-white/70{% elif 'warning' in message.tags %}border-orange-400/30 bg-gradient-to-r from-gray-950/90 to-orange-950/35 before:absolute before:inset-y-0 before:left-0 before:w-1 before:bg-gradient-to-b before:from-orange-400 before:to-amber-400 dark:border-orange-200/70 dark:from-orange-50/90 dark:to-white/70{% else %}border-blue-400/30 bg-gradient-to-r from-gray-950/90 to-blue-950/35 before:absolute before:inset-y-0 before:left-0 before:w-1 before:bg-gradient-to-b before:from-blue-400 before:to-indigo-400 dark:border-blue-200/70 dark:from-blue-50/90 dark:to-white/70{% endif %}">
                                <div class="flex items-center gap-3 p-4 pl-5">
                                    <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-xl ring-1 ring-inset {% if 'error' in message.tags or 'danger' in message.tags %}bg-red-100/80 text-red-700 ring-red-200 dark:bg-red-900/40 dark:text-red-300 dark:ring-red-900/50{% elif 'success' in message.tags %}bg-emerald-100/80 text-emerald-700 ring-emerald-200 dark:bg-emerald-900/40 dark:text-emerald-300 dark:ring-emerald-900/50{% elif 'warning' in message.tags %}bg-orange-100/80 text-orange-700 ring-orange-200 dark:bg-orange-900/40 dark:text-orange-300 dark:ring-orange-900/50{% else %}bg-blue-100/80 text-blue-700 ring-blue-200 dark:bg-blue-900/40 dark:text-blue-300 dark:ring-blue-900/50{% endif %}">
                                        {% if 'error' in message.tags or 'danger' in message.tags %}
                                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                        {% elif 'success' in message.tags %}
                                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        {% elif 'warning' in message.tags %}
                                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                        {% else %}
                                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-semibold leading-snug text-center text-white dark:text-gray-900 break-words">
                                            {{ message }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endif %}
    {% block content %}
    {% endblock %}

    {% if user.is_authenticated %}
        {% include '_bottom_nav.html' %}
        {% include '_mobile_menu.html' %}
    {% endif %}



{% compress js %}
<script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script nonce="{{request.csp_nonce}}" src="{% static 'js/htmx.min.js' %}"></script>
    <script nonce="{{request.csp_nonce}}" src="{% static 'js/tex-mml-chtml.js' %}"></script>
    <script nonce="{{request.csp_nonce}}" type="text/javascript" src="{% static 'js/tabulator.min.js' %}"></script>
<script src="{% static 'js/notifications.js' %}"></script>
    <script src="{% static 'js/script.js' %}"></script>
    <script src="{% static 'js/errors_form.js' %}"></script>
    <script src="{% static 'js/account_group_filter.js' %}"></script>
    <script src="{% static 'js/balance_trend_widget.js' %}"></script>
    <script src="{% static 'js/lazy-loader.js' %}"></script>
    <script src="{% static 'js/mathjax.js' %}"></script>
    {% if user.is_authenticated %}
        <script src="{% static 'js/header.js' %}"></script>
        <script src="{% static 'js/bottom-nav.js' %}"></script>
        <script src="{% static 'js/upload.js' %}"></script>
    {% endif %}
    {% endcompress %}
    {% if user.is_authenticated %}
    <script nonce="{{request.csp_nonce}}">
        // Set flag for authenticated user BEFORE loading site-tour.js
        window.userIsAuthenticated = true;
    </script>
    <script src="{% static 'js/driver.js' %}" nonce="{{request.csp_nonce}}"></script>
    <script src="{% static 'js/site-tour.js' %}" nonce="{{request.csp_nonce}}"></script>
    {% endif %}
    <script nonce="{{request.csp_nonce}}">
        (function() {
            if (typeof window.LazyLoader === 'undefined') {
                return;
            }

            const currentPath = '{{ request.path|escapejs }}';
            const cspNonce = '{{ request.csp_nonce|escapejs }}';

            function loadScript(src) {
                if (typeof window.LazyLoader === 'undefined') {
                    console.error('[BASE] LazyLoader is not available!');
                    return Promise.reject(new Error('LazyLoader not available'));
                }
                return window.LazyLoader.loadScript(src, {
                    nonce: cspNonce
                });
            }

            if (currentPath.indexOf('receipts') !== -1) {
                loadScript('{% static "js/receipt_filter.js" %}?v={% word_hash %}').catch(function(error) {
                    console.error('Error loading receipt_filter script:', error);
                });

                loadScript('{% static "js/tokens.js" %}?v={% word_hash %}').then(function() {
                    return loadScript('{% static "js/receipt_group_filter.js" %}?v={% word_hash %}');
                }).then(function() {
                    if (currentPath.indexOf('update') !== -1) {
                        return loadScript('{% static "js/receipt_update.js" %}?v={% word_hash %}');
                    }
                }).catch(function(error) {
                    console.error('Error loading receipt scripts:', error);
                });
            }

            if (currentPath.indexOf('budget') !== -1) {
                function loadBudgetScript() {
                    loadScript('{% static "js/budget.js" %}?v={% word_hash %}').catch(function(error) {
                        console.error('[BASE] Error loading budget script:', error);
                    });
                }

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', loadBudgetScript);
                } else {
                    loadBudgetScript();
                }
            }

            {% if user.is_authenticated %}
            loadScript('{% static "js/theme.js" %}?v={% word_hash %}').catch(function(error) {
                console.error('Error loading theme script:', error);
            });
            {% endif %}

            const isIncomePage = currentPath.indexOf('income') !== -1;
            const isExpensePage = currentPath.indexOf('expense') !== -1;
            const isBudgetPage = currentPath.indexOf('budget') !== -1;

            if (isIncomePage && !isBudgetPage) {
                loadScript('{% static "js/income_table.js" %}?v={% word_hash %}').catch(function(error) {
                    console.error('Error loading income_table script:', error);
                });
            }

            if (isExpensePage && !isBudgetPage) {
                loadScript('{% static "js/expense_table.js" %}?v={% word_hash %}').catch(function(error) {
                    console.error('Error loading expense_table script:', error);
                });
            }

            if (currentPath.indexOf('loan') !== -1) {
                loadScript('{% static "js/loan.js" %}?v={% word_hash %}').catch(function(error) {
                    console.error('Error loading loan script:', error);
                });
            }

            var shouldLoadAccountForm = currentPath.indexOf('create') !== -1 || 
                                       currentPath.indexOf('add') !== -1 || 
                                       currentPath.indexOf('change') !== -1 ||
                                       currentPath.indexOf('update') !== -1;
            
            if (shouldLoadAccountForm) {
                loadScript('{% static "js/account_form.js" %}?v={% word_hash %}').catch(function(error) {
                    console.error('Error loading account_form script:', error);
                });
            }
        })();
    </script>
    {% block extra_js %}
    {% endblock %}
    <script nonce="{{request.csp_nonce}}">
        window.SET_THEME_URL = "{% url 'users:set_theme' %}";
        window.LOGIN_URL = "{% url 'users:login' %}";
        window.GROUPS_FOR_USER_URL = "{% url 'users:ajax:groups_for_user' %}";
        window.GROUPS_NOT_FOR_USER_URL = "{% url 'users:ajax:groups_not_for_user' %}";
    </script>
</body>
</html>
