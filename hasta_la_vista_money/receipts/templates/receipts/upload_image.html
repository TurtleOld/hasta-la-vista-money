{% extends 'base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load static %}
{% load csp %}

{% block title %}{% translate 'Загрузка чеков с изображения' %}{% endblock %}
{% block content %}
<div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-heading font-semibold text-gray-900 dark:text-gray-100">
            {% translate 'Загрузка чека' %}
        </h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
            {% translate 'Загрузите фото чека, выберите счёт и отправьте на распознавание.' %}
        </p>
        <label for="instruction-modal-toggle" class="inline-flex items-center gap-1.5 text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 cursor-pointer transition-colors" onclick="if(document.getElementById('mobileMenuState')) document.getElementById('mobileMenuState').checked = false;">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451.081.082.381 1.29.087zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
            </svg>
            {% translate 'Инструкция' %}
        </label>
    </div>

    <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 shadow-sm p-5 sm:p-6">
        <form method="post" enctype="multipart/form-data" id="uploadForm" class="space-y-5" novalidate>
            {% csrf_token %}

            <div class="space-y-3">
                <label id="upload-zone" for="file-input" class="group block cursor-pointer rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 bg-gray-50/70 dark:bg-gray-800/40 p-8 text-center transition focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-gray-900 hover:border-blue-400 dark:hover:border-blue-500">
                    <div class="flex flex-col items-center gap-3">
                        <i class="bi bi-cloud-upload text-4xl text-gray-500 dark:text-gray-300"></i>
                        <div class="space-y-1">
                            <p class="font-medium text-gray-900 dark:text-gray-100">
                                {% translate 'Перетащите изображение сюда или нажмите для выбора' %}
                            </p>
                            <p class="text-sm text-gray-600 dark:text-gray-300">
                                {% translate 'JPG, JPEG или PNG, до 5 МБ' %}
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                {% translate 'Также можно вставить изображение из буфера обмена (Ctrl+V)' %}
                            </p>
                        </div>
                    </div>
                </label>

                <input type="file" name="file" id="file-input" class="hidden" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                <div id="upload-error" class="hidden rounded-xl border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20 px-4 py-3 text-sm text-red-800 dark:text-red-200"></div>

                <div id="preview" class="hidden rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-4">
                    <div class="flex items-start gap-4">
                        <div class="h-24 w-24 flex-none overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800">
                            <img id="preview-image" class="h-full w-full object-contain" loading="eager" alt="{% translate 'Предварительный просмотр чека' %}">
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <p id="preview-filename" class="truncate text-sm font-medium text-gray-900 dark:text-gray-100"></p>
                                    <p id="preview-filesize" class="mt-1 text-xs text-gray-500 dark:text-gray-400"></p>
                                </div>
                                <button type="button" id="remove-preview" class="inline-flex items-center gap-2 rounded-lg border border-gray-200 dark:border-gray-700 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800">
                                    <i class="bi bi-trash"></i>
                                    {% translate 'Удалить' %}
                                </button>
                            </div>
                            <p class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                {% translate 'Проверьте, что чек снят без бликов и обрезанных краёв — так распознавание будет точнее.' %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-1">
                <div class="text-sm font-medium text-gray-900 dark:text-gray-100">
                    {{ form.account.label_tag }}
                </div>
                <div class="[&_select]:w-full">
                    {{ form.account }}
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
                <button type="submit" id="submitBtn" disabled class="inline-flex items-center justify-center rounded-xl bg-green-600 px-5 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-green-700 disabled:cursor-not-allowed disabled:opacity-60">
                    <span id="buttonText" class="inline-flex items-center gap-2">
                        <i class="bi bi-check2-circle"></i>
                        <span>{% translate 'Загрузить' %}</span>
                    </span>
                    <span id="loadingIcon" class="hidden inline-flex items-center gap-2 text-sm font-medium">
                        <span class="h-4 w-4 animate-spin rounded-full border-2 border-white/30 border-t-white"></span>
                        {% translate 'Загрузка...' %}
                    </span>
                </button>

                <p class="text-xs text-gray-500 dark:text-gray-400">
                    {% translate 'После загрузки вы сможете проверить позиции и суммы перед сохранением.' %}
                </p>
            </div>
        </form>
    </div>
</div>

{% include 'receipts/modal/instruction_modal.html' %}
{% endblock %}
