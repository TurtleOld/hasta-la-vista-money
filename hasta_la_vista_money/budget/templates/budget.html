{% extends 'base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load static %}
{% load csp %}

{% block title %}{% translate 'Бюджет' %}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-7xl">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-gray-100 mb-2">{% translate 'Бюджет по категориям' %}</h2>
        <p class="text-center text-gray-600 dark:text-gray-400 text-sm">{% translate 'Анализ выполнения плана по доходам и расходам' %}</p>
    </div>
    
    <div class="flex flex-wrap justify-center gap-3 mb-6">
        <a id="budget-expense-table-btn" href="{% url 'budget:expense_table' %}" class="inline-flex items-center gap-2 px-4 py-2.5 border-2 border-red-500 text-red-600 dark:text-red-400 bg-white dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-red-900/20 font-medium rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 shadow-sm hover:shadow-md">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            {% translate 'Таблица расходов' %}
        </a>
        <a id="budget-income-table-btn" href="{% url 'budget:income_table' %}" class="inline-flex items-center gap-2 px-4 py-2.5 border-2 border-green-500 text-green-600 dark:text-green-400 bg-white dark:bg-gray-800 hover:bg-green-50 dark:hover:bg-green-900/20 font-medium rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 shadow-sm hover:shadow-md">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
            {% translate 'Таблица доходов' %}
        </a>
        <a id="budget-reports-btn" href="{% url 'reports:list' %}" class="inline-flex items-center gap-2 px-4 py-2.5 border-2 border-blue-500 text-blue-600 dark:text-blue-400 bg-white dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 font-medium rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 shadow-sm hover:shadow-md">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            {% translate 'Отчёты' %}
        </a>
    </div>
    
    <div class="flex justify-center mb-6">
        <form id="generate-dates-form" class="m-0">
            {% csrf_token %}
            <div class="flex items-center gap-3">
                <select id="budget-type-select" class="px-4 py-2.5 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 font-medium rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    <option value="expense">{% translate 'Расходы' %}</option>
                    <option value="income">{% translate 'Доходы' %}</option>
                </select>
                <button id="budget-add-months-btn" type="submit" class="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-medium rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 transition-all duration-200 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    {% translate 'Добавить ещё месяцы' %}
                </button>
            </div>
        </form>
    </div>
    
    <div class="flex justify-center mb-8">
        <div class="w-full max-w-5xl">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                <canvas id="planExecutionChart" height="120"></canvas>
            </div>
        </div>
    </div>
    {{ chart_labels|json_script:"chartLabels" }}
    {{ chart_plan_execution_income|json_script:"chartPlanExecutionIncome" }}
    {{ chart_plan_execution_expense|json_script:"chartPlanExecutionExpense" }}
</div>
<script nonce="{{request.csp_nonce}}" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script nonce="{{request.csp_nonce}}">
document.addEventListener('DOMContentLoaded', function() {
    // Обработка формы генерации дат
    const generateDatesForm = document.getElementById('generate-dates-form');
    if (generateDatesForm) {
        generateDatesForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const typeSelect = document.getElementById('budget-type-select');
            const type = typeSelect ? typeSelect.value : 'expense';
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('/budget/generate-date/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'include',
                body: JSON.stringify({ type: type })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    alert('{% translate "Ошибка при генерации дат" %}');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{% translate "Произошла ошибка. Попробуйте снова." %}');
            });
        });
    }
    
    // График выполнения плана
    const planExecutionCtx = document.getElementById('planExecutionChart').getContext('2d');
    const chartLabels = JSON.parse(document.getElementById('chartLabels').textContent);
    const chartPlanExecutionIncome = JSON.parse(document.getElementById('chartPlanExecutionIncome').textContent);
    const chartPlanExecutionExpense = JSON.parse(document.getElementById('chartPlanExecutionExpense').textContent);
    new Chart(planExecutionCtx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [
                {
                    label: "{{ _('Доходы (% выполнения плана)') }}",
                    data: chartPlanExecutionIncome,
                    borderColor: 'rgba(40, 167, 69, 1)',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.1,
                    pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                },
                {
                    label: "{{ _('Расходы (% выполнения плана)') }}",
                    data: chartPlanExecutionExpense,
                    borderColor: 'rgba(220, 53, 69, 1)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.1,
                    pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: "{{ _('Выполнение плана по месяцам (%)') }}" }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: function(context) {
                        const maxValue = Math.max(...chartPlanExecutionIncome, ...chartPlanExecutionExpense);
                        return Math.max(100, Math.ceil(maxValue / 10) * 10);
                    },
                    grid: {
                        color: function(context) {
                            if (context.tick.value === 100) {
                                return 'rgba(0, 0, 0, 0.3)';
                            }
                            return 'rgba(0, 0, 0, 0.1)';
                        }
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const label = context.dataset.label;
                            return `${label}: ${value.toFixed(1)}%`;
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
