{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load static %}
{% load comma %}

{% block title %}{% translate '–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' %} - {{ user.username }}{% endblock %}

{% block content %}
    <div class="container-fluid statistics-page">
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-graph-up"></i> {% translate '–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' %}</h2>
                    <a href="{% url 'users:profile' user.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i> {% translate '–ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é' %}
                    </a>
                </div>
            </div>
            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—á–µ—Ç–∞–º -->
            <div class="col-12 mb-4">
                <div class="row statistics-summary">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-primary text-white shadow-sm statistics-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">{% translate '–í—Å–µ–≥–æ —Å—á–µ—Ç–æ–≤' %}</h5>
                                <h3 class="mb-0">{{ accounts.count }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-success text-white shadow-sm statistics-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">{% translate '–û–±—â–∏–π –±–∞–ª–∞–Ω—Å' %}</h5>
                                <h3 class="mb-0">
                                    {% for currency, balance in balances_by_currency.items %}
                                        {{ balance|comma }} {{ currency }}
                                        {% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-info text-white shadow-sm statistics-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">{% translate '–ß–µ–∫–æ–≤' %}</h5>
                                <h3 class="mb-0">{{ receipt_info_by_month|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-warning text-dark shadow-sm statistics-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">{% translate '–û–ø–µ—Ä–∞—Ü–∏–π' %}</h5>
                                <h3 class="mb-0">{{ income_expense|length }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
            <div class="col-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">{% translate '–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤' %}</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="incomeExpenseChart" class="chart-container" height="300"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="statisticsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">
                                    {% translate '–ú–µ—Å—è—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' %}
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="receipts-tab" data-bs-toggle="tab" data-bs-target="#receipts" type="button" role="tab">
                                    {% translate '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–µ–∫–∞–º' %}
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="operations-tab" data-bs-toggle="tab" data-bs-target="#operations" type="button" role="tab">
                                    {% translate '–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã' %}
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="transfers-tab" data-bs-toggle="tab" data-bs-target="#transfers" type="button" role="tab">
                                    {% translate '–ü–µ—Ä–µ–≤–æ–¥—ã' %}
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
                                    {% translate '–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π' %}
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="creditcards-tab" data-bs-toggle="tab" data-bs-target="#creditcards" type="button" role="tab">
                                    –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="statisticsTabsContent">
                            <!-- –ú–µ—Å—è—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                            <div class="tab-pane fade show active" id="monthly" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>{% translate '–ú–µ—Å—è—Ü' %}</th>
                                                <th>{% translate '–î–æ—Ö–æ–¥—ã' %}</th>
                                                <th>{% translate '–†–∞—Å—Ö–æ–¥—ã' %}</th>
                                                <th>{% translate '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è' %}</th>
                                                <th>{% translate '–ü—Ä–æ—Ü–µ–Ω—Ç —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π' %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for month in months_data %}
                                                <tr>
                                                    <td>{{ month.month }}</td>
                                                    <td class="text-success">{{ month.income|comma }} ‚ÇΩ</td>
                                                    <td class="text-danger">{{ month.expenses|comma }} ‚ÇΩ</td>
                                                    <td class="{% if month.savings >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                        {{ month.savings|comma }} ‚ÇΩ
                                                    </td>
                                                    <td>
                                                        {% if month.income > 0 %}
                                                            <span class="badge {% if month.savings >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                                                {{ month.savings_percent|floatformat:1 }}%
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">-</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–µ–∫–∞–º -->
                            <div class="tab-pane fade" id="receipts" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>{% translate '–ü–µ—Ä–∏–æ–¥' %}</th>
                                                <th>{% translate '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–∫–æ–≤' %}</th>
                                                <th>{% translate '–°—É–º–º–∞' %}</th>
                                                <th>{% translate '–°—á—ë—Ç' %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for receipt in receipt_info_by_month %}
                                                <tr>
                                                    <td>{{ receipt.month|date:"F Y" }}</td>
                                                    <td>{{ receipt.count }}</td>
                                                    <td class="text-success fw-bold">{{ receipt.total_amount|comma }}</td>
                                                    <td>{{ receipt.account__name_account }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- –î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã -->
                            <div class="tab-pane fade" id="operations" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>{% translate '–¢–∏–ø' %}</th>
                                                <th>{% translate '–ö–∞—Ç–µ–≥–æ—Ä–∏—è' %}</th>
                                                <th>{% translate '–î–∞—Ç–∞' %}</th>
                                                <th>{% translate '–°—É–º–º–∞' %}</th>
                                                <th>{% translate '–°—á—ë—Ç' %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in income_expense %}
                                                <tr>
                                                    <td>
                                                        {% if item.type == 'income' %}
                                                            <span class="badge bg-success">üí∞ {% translate '–î–æ—Ö–æ–¥' %}</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">üí∏ {% translate '–†–∞—Å—Ö–æ–¥' %}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ item.category__name }}</td>
                                                    <td>{{ item.date|date:'F Y' }}</td>
                                                    <td class="fw-bold {% if item.type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                                        {{ item.amount|comma }}
                                                    </td>
                                                    <td>{{ item.account__name_account }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- –ü–µ—Ä–µ–≤–æ–¥—ã -->
                            <div class="tab-pane fade" id="transfers" role="tabpanel">
                                <div class="list-group">
                                    {% for transfer in transfer_money_log %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ transfer.from_account.name_account }}</strong>
                                                    <i class="bi bi-arrow-right mx-2"></i>
                                                    <strong>{{ transfer.to_account.name_account }}</strong>
                                                </div>
                                                <span class="badge bg-primary">{{ transfer.amount|comma }}</span>
                                            </div>
                                            <small class="text-muted">{{ transfer.created_at|date:"d.m.Y H:i" }}</small>
                                        </div>
                                    {% empty %}
                                        <div class="text-center text-muted py-4">
                                            {% translate '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–µ—Ä–µ–≤–æ–¥–∞—Ö' %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                            <div class="tab-pane fade" id="categories" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>{% translate '–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤' %}</h6>
                                        {% if top_expense_categories %}
                                            <div class="list-group list-group-flush">
                                                {% for category in top_expense_categories %}
                                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>{{ category.category__name }}</span>
                                                        <span class="badge bg-danger rounded-pill">
                                                            {{ category.total|comma }} ‚ÇΩ
                                                        </span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <p class="text-muted">{% translate '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö' %}</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <h6>{% translate '–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ—Ö–æ–¥–æ–≤' %}</h6>
                                        {% if top_income_categories %}
                                            <div class="list-group list-group-flush">
                                                {% for category in top_income_categories %}
                                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>{{ category.category__name }}</span>
                                                        <span class="badge bg-success rounded-pill">
                                                            {{ category.total|comma }} ‚ÇΩ
                                                        </span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <p class="text-muted">{% translate '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Ö–æ–¥–∞—Ö' %}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã -->
                            <div class="tab-pane fade" id="creditcards" role="tabpanel">
                                {% if credit_cards_data %}
                                <div class="accordion" id="creditCardsAccordion">
                                    {% for card in credit_cards_data %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                    data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false"
                                                    aria-controls="collapse{{ forloop.counter }}">
                                                {{ card.name }} ‚Äî {{ card.limit|comma }} {{ card.currency }} (–î–æ–ª–≥: {{ card.debt_now|comma }} {{ card.currency }})
                                            </button>
                                        </h2>
                                        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse"
                                             aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#creditCardsAccordion">
                                            <div class="accordion-body">
                                                <table class="table table-bordered align-middle mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>–õ–∏–º–∏—Ç</th>
                                                            <th>–î–æ–ª–≥</th>
                                                            <th>–û—Å—Ç–∞—Ç–æ–∫ –ª–∏–º–∏—Ç–∞</th>
                                                            <th>–ë–ª–∏–∂–∞–π—à–∏–π –ø–ª–∞—Ç—ë–∂</th>
                                                            <th>–ò—Å—Ç–æ—Ä–∏—è (12 –º–µ—Å.)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>{{ card.limit|comma }} {{ card.currency }}</td>
                                                            <td>{{ card.debt_now|comma }} {{ card.currency }}</td>
                                                            <td>{{ card.limit_left|comma }} {{ card.currency }}</td>
                                                            <td>{% if card.payment_due_date %}{{ card.payment_due_date|date:'d.m.Y' }}{% else %}-{% endif %}</td>
                                                            <td style="min-width: 180px;">
                                                                {% for h in card.history %}
                                                                    <span class="d-inline-block me-2 small">{{ h.month }}: <span class="fw-semibold">{{ h.debt|comma }}</span></span>
                                                                {% endfor %}
                                                            </td>
                                                        </tr>
                                                        {% if card.payment_schedule %}
                                                        <tr>
                                                            <td colspan="5">
                                                                <div class="mt-2">
                                                                    <strong>–ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –≥—Ä–µ–π—Å-–ø–µ—Ä–∏–æ–¥—É:</strong>
                                                                    <div class="table-responsive">
                                                                        <table class="table table-sm table-bordered align-middle mb-0 mt-1">
                                                                            <thead class="table-light">
                                                                                <tr>
                                                                                    <th>–ú–µ—Å—è—Ü</th>
                                                                                    <th>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</th>
                                                                                    <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                {% for p in card.payment_schedule %}
                                                                                <tr>
                                                                                    <td>{{ p.month }}</td>
                                                                                    <td>{{ p.sum_expense|comma }} {{ card.currency }}</td>
                                                                                    <td>{{ p.payment_due }}</td>
                                                                                </tr>
                                                                                {% endfor %}
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-center text-muted py-3">–ù–µ—Ç –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –∫–∞—Ä—Ç!</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script nonce="{{ request.csp_nonce }}" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script nonce="{{ request.csp_nonce }}">

        document.addEventListener('DOMContentLoaded', function() {
            const chartData = {{ chart_combined|safe }};
            const ctx = document.getElementById('incomeExpenseChart');
            if (ctx && typeof Chart !== 'undefined') {
                try {
                    if (!chartData.labels || chartData.labels.length === 0) {
                        ctx.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-graph-up fs-1"></i><p class="mt-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p></div>';
                        return;
                    }

                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartData.labels || [],
                            datasets: [
                                {
                                    label: '–†–∞—Å—Ö–æ–¥—ã',
                                    data: chartData.expense_data || [],
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    tension: 0.1,
                                    borderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: '–î–æ—Ö–æ–¥—ã',
                                    data: chartData.income_data || [],
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    tension: 0.1,
                                    borderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString('ru-RU') + ' ‚ÇΩ';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '–°—É–º–º–∞ (‚ÇΩ)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: '–î–∞—Ç–∞'
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                }
            } else {
                console.error('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        });
    </script>
{% endblock %}
