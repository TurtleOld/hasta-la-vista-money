{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load static %}
{% load comma %}

{% block title %}{% translate '–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' %} - {{ user.username }}{% endblock %}

{% block content %}
    <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 statistics-page">
        <div class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <h2 class="text-2xl sm:text-3xl font-heading font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <i class="bi bi-graph-up text-green-600 dark:text-green-400"></i>
                    {% translate '–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' %}
                </h2>
                <a href="{% url 'users:profile' user.id %}" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 border border-blue-300 dark:border-blue-700 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors duration-200">
                    <i class="bi bi-arrow-left"></i>
                    {% translate '–ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é' %}
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 statistics-summary">
            <div class="bg-gradient-to-br from-blue-600 to-indigo-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-6">
                <div class="text-center">
                    <h5 class="text-sm font-medium text-blue-100 mb-2">{% translate '–í—Å–µ–≥–æ —Å—á–µ—Ç–æ–≤' %}</h5>
                    <h3 class="text-3xl font-bold">{{ accounts.count }}</h3>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-600 to-emerald-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-6">
                <div class="text-center">
                    <h5 class="text-sm font-medium text-green-100 mb-2">{% translate '–û–±—â–∏–π –±–∞–ª–∞–Ω—Å' %}</h5>
                    <h3 class="text-lg sm:text-xl font-bold">
                        {% for currency, balance in balances_by_currency.items %}
                            {{ balance|comma }} {{ currency }}
                            {% if not forloop.last %}<br class="hidden sm:block">{% endif %}
                        {% endfor %}
                    </h3>
                </div>
            </div>
            <div class="bg-gradient-to-br from-cyan-600 to-blue-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-6">
                <div class="text-center">
                    <h5 class="text-sm font-medium text-cyan-100 mb-2">{% translate '–ß–µ–∫–æ–≤' %}</h5>
                    <h3 class="text-3xl font-bold">{{ receipt_info_by_month|length }}</h3>
                </div>
            </div>
            <div class="bg-gradient-to-br from-amber-500 to-orange-500 text-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-6">
                <div class="text-center">
                    <h5 class="text-sm font-medium text-amber-100 mb-2">{% translate '–û–ø–µ—Ä–∞—Ü–∏–π' %}</h5>
                    <h3 class="text-3xl font-bold">{{ income_expense|length }}</h3>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                    <h5 class="text-lg font-semibold text-gray-900 dark:text-white">{% translate '–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤' %}</h5>
                </div>
                <div class="p-6">
                    <canvas id="incomeExpenseChart" class="chart-container" height="300"></canvas>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                    <div class="flex flex-wrap gap-2 px-4 sm:px-6 pt-4 overflow-x-auto" id="statisticsTabs" role="tablist">
                        <button class="statistics-tab-btn active px-4 py-2 text-sm font-medium rounded-t-lg transition-all duration-200 bg-white dark:bg-gray-800 text-green-600 dark:text-green-400 border-b-2 border-green-600 dark:border-green-400" id="monthly-tab" data-tab-target="monthly" type="button" role="tab">
                            {% translate '–ú–µ—Å—è—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' %}
                        </button>
                        <button class="statistics-tab-btn px-4 py-2 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" id="receipts-tab" data-tab-target="receipts" type="button" role="tab">
                            {% translate '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–µ–∫–∞–º' %}
                        </button>
                        <button class="statistics-tab-btn px-4 py-2 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" id="operations-tab" data-tab-target="operations" type="button" role="tab">
                            {% translate '–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã' %}
                        </button>
                        <button class="statistics-tab-btn px-4 py-2 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" id="transfers-tab" data-tab-target="transfers" type="button" role="tab">
                            {% translate '–ü–µ—Ä–µ–≤–æ–¥—ã' %}
                        </button>
                        <button class="statistics-tab-btn px-4 py-2 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" id="categories-tab" data-tab-target="categories" type="button" role="tab">
                            {% translate '–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π' %}
                        </button>
                        <button class="statistics-tab-btn px-4 py-2 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" id="creditcards-tab" data-tab-target="creditcards" type="button" role="tab">
                            –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã
                        </button>
                    </div>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="statisticsTabsContent">
                        <div class="statistics-tab-pane active" id="monthly" role="tabpanel">
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-50 dark:bg-gray-900/50">
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–ú–µ—Å—è—Ü' %}</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–î–æ—Ö–æ–¥—ã' %}</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–†–∞—Å—Ö–æ–¥—ã' %}</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è' %}</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–ü—Ä–æ—Ü–µ–Ω—Ç —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π' %}</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                        {% for month in months_data %}
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors duration-150">
                                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ month.month }}</td>
                                                <td class="px-4 py-3 text-sm font-medium text-green-600 dark:text-green-400 text-right">{{ month.income|comma }} ‚ÇΩ</td>
                                                <td class="px-4 py-3 text-sm font-medium text-red-600 dark:text-red-400 text-right">{{ month.expenses|comma }} ‚ÇΩ</td>
                                                <td class="px-4 py-3 text-sm font-medium {% if month.savings >= 0 %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %} text-right">
                                                    {{ month.savings|comma }} ‚ÇΩ
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    {% if month.income > 0 %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if month.savings >= 0 %}bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300{% else %}bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300{% endif %}">
                                                            {{ month.savings_percent|floatformat:1 }}%
                                                        </span>
                                                    {% else %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">-</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="statistics-tab-pane hidden" id="receipts" role="tabpanel">
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-50 dark:bg-gray-900/50">
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–ü–µ—Ä–∏–æ–¥' %}</th>
                                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–∫–æ–≤' %}</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–°—É–º–º–∞' %}</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–°—á—ë—Ç' %}</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                        {% for receipt in receipt_info_by_month %}
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors duration-150">
                                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ receipt.month|date:"F Y" }}</td>
                                                <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300 text-center">{{ receipt.count }}</td>
                                                <td class="px-4 py-3 text-sm font-semibold text-green-600 dark:text-green-400 text-right">{{ receipt.total_amount|comma }}</td>
                                                <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">{{ receipt.account__name_account }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="statistics-tab-pane hidden" id="operations" role="tabpanel">
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-50 dark:bg-gray-900/50">
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–¢–∏–ø' %}</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–ö–∞—Ç–µ–≥–æ—Ä–∏—è' %}</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–î–∞—Ç–∞' %}</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–°—É–º–º–∞' %}</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">{% translate '–°—á—ë—Ç' %}</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                        {% for item in income_expense %}
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors duration-150">
                                                <td class="px-4 py-3">
                                                    {% if item.type == 'income' %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">üí∞ {% translate '–î–æ—Ö–æ–¥' %}</span>
                                                    {% else %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">üí∏ {% translate '–†–∞—Å—Ö–æ–¥' %}</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ item.category__name }}</td>
                                                <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">{{ item.date|date:'F Y' }}</td>
                                                <td class="px-4 py-3 text-sm font-semibold {% if item.type == 'income' %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %} text-right">
                                                    {{ item.amount|comma }}
                                                </td>
                                                <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">{{ item.account__name_account }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="statistics-tab-pane hidden" id="transfers" role="tabpanel">
                            <div class="space-y-3">
                                {% for transfer in transfer_money_log %}
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-150">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <span class="font-semibold text-gray-900 dark:text-white">{{ transfer.from_account.name_account }}</span>
                                            <i class="bi bi-arrow-right text-gray-400 dark:text-gray-500"></i>
                                            <span class="font-semibold text-gray-900 dark:text-white">{{ transfer.to_account.name_account }}</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">{{ transfer.amount|comma }}</span>
                                            <span class="text-xs text-gray-500 dark:text-gray-400">{{ transfer.created_at|date:"d.m.Y H:i" }}</span>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                                        <i class="bi bi-inbox text-4xl mb-2 block"></i>
                                        <p>{% translate '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–µ—Ä–µ–≤–æ–¥–∞—Ö' %}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="statistics-tab-pane hidden" id="categories" role="tabpanel">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h6 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% translate '–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤' %}</h6>
                                    {% if top_expense_categories %}
                                        <div class="space-y-2">
                                            {% for category in top_expense_categories %}
                                                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-150">
                                                    <span class="text-sm text-gray-900 dark:text-gray-100">{{ category.category__name }}</span>
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">
                                                        {{ category.total|comma }} ‚ÇΩ
                                                    </span>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-gray-500 dark:text-gray-400">{% translate '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö' %}</p>
                                    {% endif %}
                                </div>
                                <div>
                                    <h6 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{% translate '–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ—Ö–æ–¥–æ–≤' %}</h6>
                                    {% if top_income_categories %}
                                        <div class="space-y-2">
                                            {% for category in top_income_categories %}
                                                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-150">
                                                    <span class="text-sm text-gray-900 dark:text-gray-100">{{ category.category__name }}</span>
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">
                                                        {{ category.total|comma }} ‚ÇΩ
                                                    </span>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-gray-500 dark:text-gray-400">{% translate '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Ö–æ–¥–∞—Ö' %}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="statistics-tab-pane hidden" id="creditcards" role="tabpanel">
                            {% if credit_cards_data %}
                            <div class="space-y-4" id="creditCardsAccordion">
                                {% for card in credit_cards_data %}
                                <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800">
                                    <h2 id="heading{{ forloop.counter }}">
                                        <button class="credit-card-accordion-btn w-full px-6 py-4 text-left flex items-center justify-between bg-gray-50 dark:bg-gray-900/50 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200" type="button" data-accordion-target="collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                                            <span class="font-medium text-gray-900 dark:text-white">{{ card.name }} ‚Äî {{ card.limit|comma }} {{ card.currency }} (–î–æ–ª–≥: {{ card.debt_now|comma }} {{ card.currency }})</span>
                                            <i class="bi bi-chevron-down text-gray-400 dark:text-gray-500 transition-transform duration-200"></i>
                                        </button>
                                    </h2>
                                    <div id="collapse{{ forloop.counter }}" class="credit-card-accordion-content hidden" aria-labelledby="heading{{ forloop.counter }}">
                                        <div class="p-6 space-y-4">
                                            {% if card.current_grace_info %}
                                            <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                                                <h6 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                                                    <i class="bi bi-calendar-check text-blue-600 dark:text-blue-400"></i>
                                                    –¢–µ–∫—É—â–∏–π –±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥
                                                </h6>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div class="space-y-2">
                                                        <p class="text-sm"><strong class="text-gray-700 dark:text-gray-300">–ü–µ—Ä–∏–æ–¥ –ø–æ–∫—É–ø–æ–∫:</strong> <span class="text-gray-900 dark:text-white">{{ card.current_grace_info.purchase_month }}</span></p>
                                                        <p class="text-sm"><strong class="text-gray-700 dark:text-gray-300">–ö–æ–Ω–µ—Ü –±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞:</strong> <span class="text-gray-900 dark:text-white">{{ card.current_grace_info.grace_end|date:'d.m.Y' }}</span></p>
                                                        {% if card.current_grace_info.days_until_due > 0 %}
                                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: {{ card.current_grace_info.days_until_due }}</span>
                                                        {% elif card.current_grace_info.is_overdue %}
                                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="space-y-2">
                                                        <p class="text-sm"><strong class="text-gray-700 dark:text-gray-300">–î–æ–ª–≥ –∑–∞ –º–µ—Å—è—Ü:</strong> <span class="text-gray-900 dark:text-white">{{ card.current_grace_info.debt_for_month|comma }} {{ card.currency }}</span></p>
                                                        <p class="text-sm"><strong class="text-gray-700 dark:text-gray-300">–ü–ª–∞—Ç–µ–∂–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ –ø–æ–≥–∞—à–µ–Ω–∏—è:</strong> <span class="text-gray-900 dark:text-white">{{ card.current_grace_info.payments_for_period|comma }} {{ card.currency }}</span></p>
                                                        <p class="text-sm"><strong class="text-gray-700 dark:text-gray-300">–ò—Ç–æ–≥–æ–≤—ã–π –¥–æ–ª–≥:</strong> <span class="text-gray-900 dark:text-white font-semibold">{{ card.current_grace_info.final_debt|comma }} {{ card.currency }}</span></p>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}

                                            <div class="overflow-x-auto">
                                                <table class="w-full border-collapse">
                                                    <thead>
                                                        <tr class="bg-gray-50 dark:bg-gray-900/50">
                                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–õ–∏–º–∏—Ç</th>
                                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–î–æ–ª–≥</th>
                                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–û—Å—Ç–∞—Ç–æ–∫ –ª–∏–º–∏—Ç–∞</th>
                                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–ò—Å—Ç–æ—Ä–∏—è (12 –º–µ—Å.)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700">{{ card.limit|comma }} {{ card.currency }}</td>
                                                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700">{{ card.debt_now|comma }} {{ card.currency }}</td>
                                                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700">{{ card.limit_left|comma }} {{ card.currency }}</td>
                                                            <td class="px-4 py-3 text-sm border-b border-gray-200 dark:border-gray-700">
                                                                <div class="flex flex-wrap gap-2">
                                                                    {% for h in card.history %}
                                                                        <div class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-gray-100 dark:bg-gray-700">
                                                                            <span class="font-semibold text-gray-700 dark:text-gray-300">{{ h.month }}:</span>
                                                                            <span class="{% if h.is_overdue %}text-red-600 dark:text-red-400{% else %}text-green-600 dark:text-green-400{% endif %}">
                                                                                {{ h.debt|comma }}
                                                                            </span>
                                                                            {% if h.is_overdue %}
                                                                                <i class="bi bi-exclamation-triangle text-red-600 dark:text-red-400" title="–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"></i>
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% if card.payment_schedule %}
                                                        <tr>
                                                            <td colspan="4" class="px-0 py-0">
                                                                <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-900/50">
                                                                    <h6 class="text-base font-semibold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                                                                        <i class="bi bi-calendar-event text-blue-600 dark:text-blue-400"></i>
                                                                        –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É
                                                                    </h6>
                                                                    <div class="overflow-x-auto">
                                                                        <table class="w-full border-collapse text-sm">
                                                                            <thead>
                                                                                <tr class="bg-gray-100 dark:bg-gray-800">
                                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–ú–µ—Å—è—Ü –ø–æ–∫—É–ø–æ–∫</th>
                                                                                    <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–°—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫</th>
                                                                                    <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–û–ø–ª–∞—á–µ–Ω–æ</th>
                                                                                    <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–û—Å—Ç–∞–ª–æ—Å—å</th>
                                                                                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                                                                                    <th class="px-3 py-2 text-center text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700">–°—Ç–∞—Ç—É—Å</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                                                                {% for p in card.payment_schedule %}
                                                                                <tr class="{% if p.is_overdue %}bg-red-50 dark:bg-red-900/20{% elif p.is_paid %}bg-green-50 dark:bg-green-900/20{% else %}hover:bg-gray-50 dark:hover:bg-gray-800/50{% endif %} transition-colors duration-150">
                                                                                    <td class="px-3 py-2 text-sm text-gray-900 dark:text-white">{{ p.month }}</td>
                                                                                    <td class="px-3 py-2 text-sm text-gray-900 dark:text-white text-right">{{ p.sum_expense|comma }} {{ card.currency }}</td>
                                                                                    <td class="px-3 py-2 text-sm font-medium text-green-600 dark:text-green-400 text-right">{{ p.payments_made|comma }} {{ card.currency }}</td>
                                                                                    <td class="px-3 py-2 text-sm font-medium {% if p.remaining_debt > 0 %}text-red-600 dark:text-red-400{% else %}text-green-600 dark:text-green-400{% endif %} text-right">
                                                                                        {{ p.remaining_debt|comma }} {{ card.currency }}
                                                                                    </td>
                                                                                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">{{ p.payment_due }}</td>
                                                                                    <td class="px-3 py-2 text-center">
                                                                                        {% if p.is_paid %}
                                                                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">–û–ø–ª–∞—á–µ–Ω–æ</span>
                                                                                        {% elif p.is_overdue %}
                                                                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                                                                                        {% elif p.days_until_due > 0 %}
                                                                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300">–û—Å—Ç–∞–ª–æ—Å—å {{ p.days_until_due }} –¥–Ω.</span>
                                                                                        {% else %}
                                                                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
                                                                                        {% endif %}
                                                                                    </td>
                                                                                </tr>
                                                                                {% endfor %}
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                                <i class="bi bi-credit-card text-4xl mb-2 block"></i>
                                <p>–ù–µ—Ç –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –∫–∞—Ä—Ç!</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script nonce="{{ request.csp_nonce }}" src="{% static 'js/chart.umd.min.js' %}"></script>
    <script nonce="{{ request.csp_nonce }}">
        document.addEventListener('DOMContentLoaded', function() {
            const chartData = {{ chart_combined|safe }};
            const ctx = document.getElementById('incomeExpenseChart');
            if (ctx && typeof Chart !== 'undefined') {
                try {
                    if (!chartData.labels || chartData.labels.length === 0) {
                        ctx.parentElement.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-12"><i class="bi bi-graph-up text-5xl mb-3 block"></i><p class="text-lg">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p></div>';
                        return;
                    }

                    const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                                   (document.documentElement.classList.contains('dark') || 
                                    window.matchMedia('(prefers-color-scheme: dark)').matches);

                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartData.labels || [],
                            datasets: [
                                {
                                    label: '–†–∞—Å—Ö–æ–¥—ã',
                                    data: chartData.expense_data || [],
                                    borderColor: 'rgb(220, 38, 38)',
                                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                    tension: 0.1,
                                    borderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: '–î–æ—Ö–æ–¥—ã',
                                    data: chartData.income_data || [],
                                    borderColor: 'rgb(22, 163, 74)',
                                    backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                    tension: 0.1,
                                    borderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                title: {
                                    display: false
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        color: isDark ? 'rgb(243, 244, 246)' : 'rgb(17, 24, 39)'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: isDark ? 'rgba(31, 41, 55, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                                    titleColor: isDark ? 'rgb(243, 244, 246)' : 'rgb(17, 24, 39)',
                                    bodyColor: isDark ? 'rgb(243, 244, 246)' : 'rgb(17, 24, 39)',
                                    borderColor: isDark ? 'rgb(55, 65, 81)' : 'rgb(229, 231, 235)',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString('ru-RU') + ' ‚ÇΩ';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '–°—É–º–º–∞ (‚ÇΩ)',
                                        color: isDark ? 'rgb(243, 244, 246)' : 'rgb(17, 24, 39)'
                                    },
                                    ticks: {
                                        color: isDark ? 'rgb(156, 163, 175)' : 'rgb(107, 114, 128)',
                                        callback: function(value) {
                                            return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                                        }
                                    },
                                    grid: {
                                        color: isDark ? 'rgba(55, 65, 81, 0.5)' : 'rgba(229, 231, 235, 0.5)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: '–î–∞—Ç–∞',
                                        color: isDark ? 'rgb(243, 244, 246)' : 'rgb(17, 24, 39)'
                                    },
                                    ticks: {
                                        color: isDark ? 'rgb(156, 163, 175)' : 'rgb(107, 114, 128)'
                                    },
                                    grid: {
                                        color: isDark ? 'rgba(55, 65, 81, 0.5)' : 'rgba(229, 231, 235, 0.5)'
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                }
            } else {
                console.error('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }

            const tabButtons = document.querySelectorAll('.statistics-tab-btn');
            const tabPanes = document.querySelectorAll('.statistics-tab-pane');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-tab-target');
                    
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'bg-white', 'dark:bg-gray-800', 'text-green-600', 'dark:text-green-400', 'border-green-600', 'dark:border-green-400', 'border-b-2');
                        btn.classList.add('text-gray-600', 'dark:text-gray-400');
                    });
                    
                    tabPanes.forEach(pane => {
                        pane.classList.add('hidden');
                        pane.classList.remove('active');
                    });
                    
                    this.classList.add('active', 'bg-white', 'dark:bg-gray-800', 'text-green-600', 'dark:text-green-400', 'border-b-2', 'border-green-600', 'dark:border-green-400');
                    this.classList.remove('text-gray-600', 'dark:text-gray-400');
                    
                    const targetPane = document.getElementById(targetId);
                    if (targetPane) {
                        targetPane.classList.remove('hidden');
                        targetPane.classList.add('active');
                    }
                });
            });

            const accordionButtons = document.querySelectorAll('.credit-card-accordion-btn');
            accordionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-accordion-target');
                    const content = document.getElementById(targetId);
                    const icon = this.querySelector('i');
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    
                    if (content) {
                        if (isExpanded) {
                            content.classList.add('hidden');
                            icon.classList.remove('rotate-180');
                            this.setAttribute('aria-expanded', 'false');
                        } else {
                            content.classList.remove('hidden');
                            icon.classList.add('rotate-180');
                            this.setAttribute('aria-expanded', 'true');
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}
