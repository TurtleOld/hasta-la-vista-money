# Управление чеками

![receipts page](https://media.githubusercontent.com/media/TurtleOld/hasta-la-vista-money/refs/heads/main/docs/img/receipts_page.png)

Модуль чеков предоставляет комплексное решение для управления кассовыми чеками, включая автоматическое распознавание с помощью ИИ, ручное добавление и детальную аналитику покупок.

!!! abstract "Основные возможности"

    - **Автоматическое распознавание чеков** с помощью ИИ
    - **Ручное добавление чеков** с детализацией товаров
    - **Фильтрация и поиск** по различным критериям
    - **Аналитика покупок** по месяцам и категориям
    - **Интеграция с расходами** для автоматического учета

## Обзор системы

### Структура данных

Система чеков состоит из трех основных моделей:

```python
class Seller(models.Model):
    """Продавец/магазин"""
    name_seller = models.CharField(max_length=255)
    retail_place_address = models.CharField(max_length=1000)
    retail_place = models.CharField(max_length=1000)

class Product(models.Model):
    """Товар в чеке"""
    product_name = models.CharField(max_length=1000)
    category = models.CharField(max_length=250)
    price = models.DecimalField(max_digits=10, decimal_places=2)
    quantity = models.DecimalField(max_digits=10, decimal_places=2)
    amount = models.DecimalField(max_digits=10, decimal_places=2)

class Receipt(models.Model):
    """Кассовый чек"""
    receipt_date = models.DateTimeField()
    number_receipt = models.IntegerField()
    total_sum = models.DecimalField(max_digits=10, decimal_places=2)
    operation_type = models.IntegerField(choices=OPERATION_TYPES)
    seller = models.ForeignKey(Seller)
    account = models.ForeignKey(Account)
    product = models.ManyToManyField(Product)
```

### Типы операций

Поддерживаются следующие типы операций:

- **1 - Покупка** - обычная покупка товаров
- **2 - Возврат средств за покупку** - возврат товара
- **3 - Продажа/Выигрыш** - получение средств
- **4 - Возврат выигрыша или продажи** - возврат полученных средств

## Фильтрация чеков

!!! abstract "Фильтры"

    **Продавец**: Выпадающий список для выбора существующего продавца

    **Период**: Два поля ввода дат в формате `mm/dd/yyyy` с календарем

    **Счет**: Выпадающий список для выбора счета списания

### Использование фильтров

1. **Выберите продавца** из списка для фильтрации по конкретному магазину
2. **Укажите период** для ограничения по датам
3. **Выберите счет** для фильтрации по источнику средств
4. **Примените фильтры** для обновления списка

!!! tip "Совет"

    Фильтры можно комбинировать для получения точных результатов. Например, можно найти все покупки в конкретном магазине за определенный месяц.

## Статистика

!!! abstract "Краткая статистика"

    - **Общее количество чеков** - общее число обработанных чеков
    - **Общая сумма** - сумма всех чеков с учетом фильтров
    - **Средняя сумма чека** - среднее значение по выбранным чекам

### Детальная аналитика

Система предоставляет детальную аналитику по месяцам:

```python
# Группировка чеков по месяцам
receipt_info_by_month = Receipt.objects.filter(user=user).annotate(
    month=TruncMonth('receipt_date')
).values('month').annotate(
    total_sum=Sum('total_sum'),
    count=Count('id')
).order_by('month')
```

## Функциональные кнопки

!!! abstract "Доступные действия"

    - **Часто покупаемые товары** - анализ покупок по месяцам
    - **Добавить продавца** - создание нового продавца
    - **Добавить чек вручную** - ручное создание чека
    - **Обработка изображения чека** - автоматическое распознавание с ИИ

### Часто покупаемые товары

Анализ показывает:

- **Топ товаров** по частоте покупок
- **Суммарные траты** по каждому товару
- **Месячную динамику** покупок
- **Категории товаров** с наибольшими тратами

!!! tip "Анализ покупок"

    Используйте эту функцию для выявления паттернов покупок и оптимизации бюджета.

## Список чеков

!!! abstract "Отображение чеков"

    Список чеков представлен в виде кнопок, при нажатии на которые открывается модальное окно с детальной информацией о чеке.

### Детальная информация чека

При открытии чека отображается:

- **Информация о продавце** - название, адрес, место расчетов
- **Детали чека** - дата, номер, общая сумма
- **Список товаров** - название, цена, количество, сумма
- **НДС** - разбивка по ставкам 10% и 20%
- **Счет списания** - источник средств

### Управление чеками

Для каждого чека доступны действия:

- **Просмотр** - детальная информация
- **Удаление** - удаление чека с возвратом средств на счет

!!! warning "Важно"

    При удалении чека сумма автоматически возвращается на счет списания.

## Ручное добавление чеков

### Создание продавца

1. Нажмите кнопку "Добавить продавца"
2. Заполните форму:
   - **Название продавца** - обязательное поле
   - **Адрес** - опционально
   - **Место расчетов** - опционально
3. Сохраните

### Создание чека

1. Нажмите "Добавить чек вручную"
2. Заполните основную информацию:
   - **Продавец** - выберите из списка или создайте нового
   - **Дата и время** - дата покупки
   - **Номер чека** - номер ФД (опционально)
   - **Счет** - счет для списания
   - **Общая сумма** - итоговая сумма чека
3. Добавьте товары:
   - **Название товара** - обязательное поле
   - **Категория** - опционально
   - **Цена за единицу** - обязательное поле
   - **Количество** - обязательное поле
   - **Сумма** - рассчитывается автоматически
4. Сохраните чек

!!! tip "Советы по добавлению"

    - Номер чека должен быть уникальным
    - Сумма товара рассчитывается автоматически (цена × количество)
    - Можно добавлять неограниченное количество товаров

## Автоматическое распознавание чеков

!!! abstract "ИИ-обработка"

    Система использует искусственный интеллект для автоматического извлечения данных из изображений чеков.

### Поддерживаемые форматы

- **JPEG** (.jpg, .jpeg)
- **PNG** (.png)

### Процесс обработки

1. **Загрузите изображение** чека
2. **Выберите счет** для списания
3. **Нажмите "Загрузить"**
4. **Дождитесь обработки** ИИ
5. **Проверьте результат** и при необходимости отредактируйте

### Точность распознавания

ИИ извлекает следующие данные:

- ✅ **Название продавца** - с высокой точностью
- ✅ **Дата и время** - в формате ДД.ММ.ГГГГ ЧЧ:ММ
- ✅ **Номер чека** - числовое значение
- ✅ **Общая сумма** - с учетом копеек
- ✅ **Список товаров** - название, цена, количество
- ✅ **НДС** - разбивка по ставкам
- ✅ **Адрес** - место расчетов

!!! tip "Качество изображения"

    Для лучшего результата используйте четкие, хорошо освещенные фотографии чеков без бликов и размытия.

## Интеграция с расходами

### Автоматическое создание расходов

При добавлении чека система автоматически:

1. **Списывает сумму** с выбранного счета
2. **Создает расходы** для каждого товара
3. **Группирует по категориям** для аналитики
4. **Связывает с чеком** для отслеживания

### Отображение в расходах

Чеки отображаются в разделе расходов как:

- **Отдельная категория** "Покупки по чекам"
- **Связь с чеком** для детального просмотра
- **Группировка по месяцам** для аналитики

## API и интеграции

### REST API эндпоинты

```http
GET    /api/receipts/              # Список чеков
POST   /api/receipts/              # Создание чека
GET    /api/receipts/{id}/         # Получение чека
PUT    /api/receipts/{id}/         # Обновление чека
DELETE /api/receipts/{id}/         # Удаление чека
POST   /api/receipts/upload/       # Загрузка изображения
GET    /api/sellers/               # Список продавцов
POST   /api/sellers/               # Создание продавца
```

### Модели данных

#### Receipt (Чек)

```json
{
  "id": 1,
  "receipt_date": "2023-12-20T15:30:00Z",
  "number_receipt": 12345,
  "total_sum": "1500.00",
  "operation_type": 1,
  "seller": 1,
  "account": 1,
  "user": 1,
  "manual": true,
  "nds10": "150.00",
  "nds20": "0.00"
}
```

#### Product (Товар)

```json
{
  "id": 1,
  "product_name": "Молоко 3.2%",
  "category": "Молочные продукты",
  "price": "85.00",
  "quantity": "2.00",
  "amount": "170.00",
  "nds_type": 20,
  "nds_sum": "28.33"
}
```

## Безопасность и валидация

### Права доступа

- **Аутентификация** - все операции требуют входа
- **Изоляция данных** - пользователи видят только свои чеки
- **Проверка владельца** - операции только с собственными чеками

### Валидация данных

```python
# Проверка достаточности средств
if total_sum > account.balance:
    raise ValidationError("Недостаточно средств на счете")

# Проверка уникальности номера чека
if Receipt.objects.filter(user=user, number_receipt=number).exists():
    raise ValidationError("Чек с таким номером уже существует")
```

### Защита от ошибок

- **Транзакционность** - операции выполняются атомарно
- **Логирование** - все операции записываются
- **Восстановление** - возможность отката при ошибках

## Производительность

### Оптимизация запросов

```python
# Использование select_related для уменьшения запросов
receipts = Receipt.objects.select_related('seller', 'account').filter(user=user)

# Аннотации для агрегации
total_stats = Receipt.objects.filter(user=user).aggregate(
    total_sum=Sum('total_sum'),
    total_count=Count('id')
)
```

### Кэширование

- **Статистика** - кэширование аналитических данных
- **Списки продавцов** - кэширование для быстрого доступа
- **Фильтры** - кэширование результатов фильтрации

## Устранение неполадок

### Частые проблемы

#### "Недостаточно средств на счете"

**Причина:** Попытка создать чек на сумму, превышающую баланс.

**Решение:**

- Пополните счет перед добавлением чека
- Уменьшите сумму чека
- Выберите другой счет

#### "Чек с таким номером уже существует"

**Причина:** Попытка добавить чек с уже существующим номером.

**Решение:**

- Проверьте номер чека
- Оставьте поле пустым для автоматической нумерации
- Используйте другой номер

#### "Ошибка при обработке изображения"

**Причина:** Проблемы с качеством изображения или ИИ-сервисом.

**Решение:**

- Улучшите качество фотографии
- Проверьте подключение к интернету
- Попробуйте добавить чек вручную

### Логи и отладка

```python
import logging
logger = logging.getLogger(__name__)

def process_receipt_image(image_file):
    try:
        result = analyze_image_with_ai(image_file)
        logger.info(f"Receipt processed successfully: {result}")
        return result
    except Exception as e:
        logger.error(f"Receipt processing error: {e}")
        raise
```

## Обновления и новые функции

### Планируемые улучшения

- **Мобильное приложение** - фотографирование чеков на ходу
- **Умные категории** - автоматическая категоризация товаров

### Обратная связь

Для предложений и сообщений об ошибках:

- Создайте issue в GitHub репозитории и опишите проблему с деталями