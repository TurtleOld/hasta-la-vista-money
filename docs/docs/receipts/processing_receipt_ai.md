# Обработка чеков с помощью ИИ

!!! abstract "Автоматическое распознавание"

    Система использует искусственный интеллект для автоматического извлечения данных из изображений кассовых чеков, что значительно упрощает процесс учета покупок.

## Обзор технологии

### Используемые технологии

- **OpenAI GPT-4o** - основная модель для распознавания
- **Vision API** - анализ изображений
- **JSON парсинг** - структурированный вывод данных
- **Base64 кодирование** - передача изображений

### Архитектура системы

```python
def analyze_image_with_ai(image_base64: UploadedFile):
    """Основная функция обработки изображения"""
    client = OpenAI(
        base_url=os.environ.get('API_BASE_URL'),
        api_key=os.environ.get('API_KEY')
    )
    
    response = client.chat.completions.create(
        model=os.environ.get('API_MODEL', 'openai/gpt-4o'),
        temperature=0.6,
        messages=[
            {
                'role': 'system',
                'content': 'Системный промпт для извлечения данных'
            },
            {
                'role': 'user',
                'content': [
                    {'type': 'text', 'text': 'Инструкции по обработке'},
                    {'type': 'image_url', 'image_url': {'url': image_base64}}
                ]
            }
        ]
    )
    return response.choices[0].message.content
```

## Процесс обработки

### Шаг 1: Загрузка изображения

!!! tip "Поддерживаемые форматы"

    - **JPEG** (.jpg, .jpeg) - рекомендуемый формат
    - **PNG** (.png) - поддерживается
    - **Максимальный размер** - 10 МБ

### Шаг 2: Подготовка данных

```python
def image_to_base64(uploaded_file) -> str:
    """Преобразование изображения в Base64"""
    file_bytes = uploaded_file.read()
    encoded_str = base64.b64encode(file_bytes).decode('utf-8')
    encoded_str = encoded_str.replace('<', '&lt;').replace('>', '&gt;').replace('"', '&quot;')
    return f'data:image/jpeg;base64,{encoded_str}'
```

### Шаг 3: ИИ-обработка

Система отправляет изображение в ИИ-модель с детальными инструкциями:

```json
{
  "role": "system",
  "content": "Вы — помощник, который помогает извлекать данные с кассовых чеков. Ваша задача — проанализировать изображение и вернуть JSON без дополнительного текста."
}
```

### Шаг 4: Парсинг результата

```python
def clean_json_response(text):
    """Очистка и валидация JSON ответа"""
    # Удаление лишних символов
    # Валидация JSON структуры
    # Нормализация данных
    return json.loads(cleaned_text)
```

## Извлекаемые данные

### Основная информация чека

- ✅ **Название продавца** (`name_seller`)
- ✅ **Дата и время** (`receipt_date`) - формат ДД.ММ.ГГГГ ЧЧ:ММ
- ✅ **Номер чека** (`number_receipt`) - числовое значение
- ✅ **Общая сумма** (`total_sum`) - с учетом копеек
- ✅ **Тип операции** (`operation_type`) - 1 (покупка) или 2 (возврат)

### Информация о продавце

- ✅ **Адрес расчетов** (`retail_place_address`)
- ✅ **Место расчетов** (`retail_place`)

### Налоговая информация

- ✅ **НДС 10%** (`nds10`) - сумма налога
- ✅ **НДС 20%** (`nds20`) - сумма налога

### Товары

Для каждого товара извлекается:

- ✅ **Название товара** (`product_name`)
- ✅ **Категория** (`category`) - автоматически определяется
- ✅ **Цена за единицу** (`price`)
- ✅ **Количество** (`quantity`)
- ✅ **Общая сумма** (`amount`) - цена × количество

## Примеры обработки

### Пример 1: Простой чек

**Изображение чека:**
```
Магазин "Продукты"
Адрес: ул. Ленина, 1
Дата: 20.12.2023 15:30
ФД: 12345

1. Молоко 3.2%    85.00 x 2 = 170.00
2. Хлеб белый     45.00 x 1 = 45.00
3. Яйца 10шт      120.00 x 1 = 120.00

Итого: 335.00
НДС 20%: 55.83
```

**Результат обработки:**
```json
{
  "name_seller": "Магазин \"Продукты\"",
  "retail_place_address": "ул. Ленина, 1",
  "retail_place": "Магазин \"Продукты\"",
  "total_sum": "335.00",
  "operation_type": 1,
  "receipt_date": "20.12.2023 15:30",
  "number_receipt": 12345,
  "nds10": "0.00",
  "nds20": "55.83",
  "items": [
    {
      "product_name": "Молоко 3.2%",
      "category": "Молочные продукты",
      "price": "85.00",
      "quantity": "2.00",
      "amount": "170.00"
    },
    {
      "product_name": "Хлеб белый",
      "category": "Хлебобулочные изделия",
      "price": "45.00",
      "quantity": "1.00",
      "amount": "45.00"
    },
    {
      "product_name": "Яйца 10шт",
      "category": "Яйца",
      "price": "120.00",
      "quantity": "1.00",
      "amount": "120.00"
    }
  ]
}
```

### Пример 2: Чек с повторяющимися товарами

**Изображение чека:**
```
1. Хлеб пшеничный 25.00 руб x 2 = 50.00
2. Хлеб пшеничный 25.00 руб x 1 = 25.00
3. Молоко 3% 45.00 руб x 1 = 45.00
```

**Результат обработки:**
```json
{
  "items": [
    {
      "product_name": "Хлеб пшеничный",
      "category": "Хлебобулочные изделия",
      "price": "25.00",
      "quantity": "2.00",
      "amount": "50.00"
    },
    {
      "product_name": "Хлеб пшеничный",
      "category": "Хлебобулочные изделия",
      "price": "25.00",
      "quantity": "1.00",
      "amount": "25.00"
    },
    {
      "product_name": "Молоко 3%",
      "category": "Молочные продукты",
      "price": "45.00",
      "quantity": "1.00",
      "amount": "45.00"
    }
  ]
}
```

!!! tip "Обработка повторений"

    Каждая строка товара обрабатывается как отдельный элемент, даже если названия совпадают.

## Точность распознавания

### Факторы, влияющие на точность

- **Качество изображения** - четкость, освещение, угол съемки
- **Качество чека** - читаемость текста, состояние бумаги
- **Формат чека** - стандартные форматы распознаются лучше
- **Сложность товаров** - простые названия распознаются точнее

### Статистика точности

- **Название продавца** - 95%+
- **Дата и время** - 98%+
- **Общая сумма** - 99%+
- **Список товаров** - 90-95%
- **НДС** - 85-90%

!!! warning "Ограничения"

    - Четкие, хорошо освещенные фотографии дают лучшие результаты
    - Избегайте бликов и размытия
    - Убедитесь, что весь текст чека виден на изображении

## Настройка и конфигурация

### Переменные окружения

```bash
# API настройки
API_BASE_URL=https://models.github.ai/inference
API_KEY=your_api_key_here
API_MODEL=openai/gpt-4o

# Параметры обработки
TEMPERATURE=0.6
MAX_TOKENS=4000
```

### Параметры модели

- **Temperature: 0.6** - баланс между креативностью и точностью
- **Max tokens: 4000** - максимальная длина ответа
- **System prompt** - детальные инструкции для модели

## Обработка ошибок

### Типичные ошибки

#### "Не удалось распознать изображение"

**Причины:**
- Низкое качество изображения
- Неподдерживаемый формат
- Проблемы с ИИ-сервисом

**Решение:**
- Улучшите качество фотографии
- Попробуйте другой ракурс
- Добавьте чек вручную

#### "Некорректный JSON ответ"

**Причины:**
- Ошибки в структуре ответа ИИ
- Проблемы с парсингом

**Решение:**
- Проверьте подключение к интернету
- Попробуйте еще раз
- Обратитесь к администратору

### Логирование

```python
import logging
logger = logging.getLogger(__name__)

def process_receipt_image(image_file):
    try:
        # Преобразование в Base64
        image_base64 = image_to_base64(image_file)
        logger.info("Image converted to Base64 successfully")
        
        # ИИ-обработка
        result = analyze_image_with_ai(image_base64)
        logger.info("AI processing completed successfully")
        
        # Парсинг результата
        parsed_result = clean_json_response(result)
        logger.info("JSON parsing completed successfully")
        
        return parsed_result
        
    except Exception as e:
        logger.error(f"Receipt processing failed: {e}")
        raise
```

## Производительность

### Время обработки

- **Малые чеки** (до 10 товаров) - 3-5 секунд
- **Средние чеки** (10-20 товаров) - 5-8 секунд
- **Большие чеки** (20+ товаров) - 8-12 секунд

### Оптимизация

- **Кэширование** результатов обработки
- **Асинхронная обработка** для больших очередей
- **Сжатие изображений** перед отправкой

## Безопасность

### Защита данных

- **Шифрование** передаваемых данных
- **Временное хранение** изображений
- **Автоматическая очистка** временных файлов

### Приватность

- **Локальная обработка** - изображения не сохраняются на серверах ИИ
- **Анонимизация** - персональные данные не передаются
- **Контроль доступа** - только авторизованные пользователи

## Будущие улучшения

### Планируемые функции

- **Мобильное приложение** - фотографирование на ходу
- **Пакетная обработка** - несколько чеков одновременно
- **Умные категории** - улучшенная автоматическая категоризация
